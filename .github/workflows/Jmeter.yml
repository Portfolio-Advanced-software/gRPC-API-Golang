name: Load Test gRPC Golang API

on:
  push:
    branches: [ main ]

jobs:
  load_test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Go environment
        uses: actions/setup-go@v2
        with:
          go-version: '1.16'
          
      - name: Install dependencies
        run: |
          go mod download
          
      - name: Build API
        run: |
          go build -o api .
          
      - name: Start API server
        run: |
          ./api &
        background: true

      - name: Install JMeter
        run: |
          sudo apt update
          sudo apt install -y openjdk-8-jdk
          wget https://mirror.olnevhost.net/pub/apache/jmeter/binaries/apache-jmeter-5.4.1.tgz
          tar -xzf apache-jmeter-5.4.1.tgz
          rm apache-jmeter-5.4.1.tgz
          export JMETER_HOME=$(pwd)/apache-jmeter-5.4.1/
          export PATH=$JMETER_HOME/bin:$PATH

      - name: Run JMeter test plan
        run: |
          jmeter -n -t ./path/to/test/plan.jmx -l results.jtl -j jmeter.log -e -o report/
